name: Tests

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      checks: write
      pull-requests: write

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb libsdl2-dev cmake imagemagick

    - name: Configure CMake (Standalone Tests)
      run: cmake -B build_tests -S tests

    - name: Build All Tests
      run: cmake --build build_tests

    - name: Step 1 - Check Smoke Test (DisplayIntegrationTest)
      working-directory: build_tests
      run: xvfb-run -a ctest -R "DisplayIntegrationTest" --output-on-failure --output-junit testReport-smoke.xml

    - name: Step 2 - Check CoreLibTest
      working-directory: build_tests
      if: success()
      run: xvfb-run -a ctest -R "CoreLibTest" --output-on-failure --output-junit testReport-core.xml

    - name: Step 3 - Check GUITest
      working-directory: build_tests
      if: success()
      run: xvfb-run -a ctest -R "GUITest" --output-on-failure --output-junit testReport-gui.xml

    - name: Step 4 - Check PerformanceTest
      working-directory: build_tests
      if: success()
      run: xvfb-run -a ctest -R "DebouncePerformanceTest" --output-on-failure --output-junit testReport-perf.xml

    - name: Upload Test Report
      uses: EnricoMi/publish-unit-test-result-action/linux@v2
      if: always()
      with:
        files: build_tests/testReport-*.xml

    - name: Upload Artifacts on Failure (Smoke Test)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-artifacts
        path: |
          build_tests/actual_*.bmp
          build_tests/diff_*.bmp
